## Relační databáze

 Je založená na tabulkách, kde sloupce označují strukturu tabulky a řádky jednotlivé záznamy. Data v tabulkách lze spojovat pomocí klíčů, které utváří relace. 

[Normální formy](http://programujte.com/clanek/2008071900-normalizace-relacnich-databazi/)
[RDMBS - relační databázový model](https://www.tutorialspoint.com/mysql/mysql-introduction.htm)

### MySQL

 Je databázový server, nejčastěji používaný při vývoji webových stránek. Patří do skupiny otevřeného SW LAMP - Linux, Apache, MySQL, a PHP. 

 Pro běžné používání je uvolněn pod [GPL](https://cs.wikipedia.org/wiki/GNU_General_Public_License) licencí, pro změnu zdrojového kódu, nebo používání MySQL jinak, než dovoluje GPL, je nutné zakoupit komerční licenci (většinou v ní je zahrnuta i podpora od Sun Microsystems). 

#### Struktura MySQL

 První vrstva slouží pro obsluhu klient/server připojení, každý připojený klient dostane na MySQL serveru vlastní vlákno, které zpracovává jeho požadavky. Vlákna se cachují, takže není potřeba s nově připojeným klientem vytvářet nové vlákno. 

 Druhá vrstva zpracovává dotaz (parsuje SQL query), popřípadě vrací předem nacachovaný výsledek. Cache je pouze pro Select příkazy. 

 Třetí vrstva se stará o optimalizaci dotazu. Vytváří si interní stromovou strukturu dotazu např. Tabulka -> sloupec -> podmínka -> limit. 

 Čtvrtá vrstva jsou úložné moduly, které se starají o úložiště dat. 

*   Blackhole - přijímá data, ale neukládá

*   Memory - data jsou uložena pouze v operační paměti

*   CSV - ukládá data v csv

*   InnoDB - defaultní modul pro ukládání dat pomocí MySQL

[![Mysql architekture schema](https://upload.wikimedia.org/wikipedia/commons/7/78/Mysql_architekture_schema.png)](https://commons.wikimedia.org/wiki/File%3AMysql_architekture_schema.png "By Clary.Aldringen (Own work) [Public domain], via Wikimedia Commons")

#### Ukládání dat v MySQL

 Každá tabulka je uložena do několika souborů 

*   .frm - základní popis tabulky

*   .MYD - data

*   .MYI - indexy

[WIkipedia](https://cs.wikipedia.org/wiki/MySQL)

[InnoDB](https://cs.wikipedia.org/wiki/InnoDB)

### SQLite

 V současnosti nejpoužívanější engine pro malé a střední aplikace. Publikovaná pod public domain licencí a stále rozšiřovaná komunitou. 

*   Veškerá data vč. struktury jsou uložena v jednom souboru, který je přenositelný mezi platformami
*   Nemá separátní server proces pro obsluhu dat
*   Nabízí možnost přístupu k záznamům pomocí dotazovacího jazyka SQL

 Kromě souboru kam jsou ukládána data, SQLite používá rollback journal, kde si ukládá transakce. Pokud dojde k chybě, nebo přerušení, může SQLite obnovit svůj stav do bodu, kde byla před každou transakcí. 

 Maximální velikost databázového souboru je cca 140 TB. Většinou velikost souboru narazí dříve na limity souborového systému, než na vlastní interní limit. 

[Více o SQLite](http://www.sqlite.org/about.html)

### SQLite a C#

 Následující příklad ukazuje program, který vypisuje všechny položky TodoItem z databáze. V programu jsou i metody pro ukládání, mazání a přidávání záznamů do SQLite databáze. 

#### Nuget balíček

 Pro jednotné použití SQLite i v Xamarin (PCL) je vybrán Nuget balíček [SQLite-net PCL](https://www.nuget.org/packages/sqlite-net-pcl/). Pro přístup k databázi bez ohledu na PCL mohou být využité i jiné balíčky např. System.Data.SQLite. 

[SQLite-net PCL oficiální Github page](https://github.com/praeclarum/sqlite-net)

#### Vytvoření struktury databáze

 K práci s databází je potřeba instance SQLiteAsyncConnection. K vytvoření struktury tabulek v databázi je dobré vytvořit třídu, která reprezentuje tabulku a určit primární klíč, popř. další atributy. 

 SQLite connection + query na tabulku TodoItem v databázi. Veškerá query jsou Asynchronní - neblukují vlákno při dotazování, je možné je nahradit synchonními (umazat Async a Task). 

    <code class="language-C# ">public class TodoItemDatabase
    {
        private SQLiteAsyncConnection database;

        public TodoItemDatabase(string dbPath)
        {
            database = new SQLiteAsyncConnection(dbPath);
            database.CreateTableAsync<TodoItem>().Wait();
        }

        public Task<List<TodoItem>> GetItemsAsync()
        {
            return database.Table<TodoItem>().ToListAsync();
        }

        public Task<List<TodoItem>> GetItemsNotDoneAsync()
        {
            return database.QueryAsync<TodoItem>("SELECT * FROM [TodoItem] WHERE [Done] = 0"); // klasické SQL
        }

        public Task<TodoItem> GetItemAsync(int id)
        {
            return database.Table<TodoItem>().Where(i => i.ID == id).FirstOrDefaultAsync(); // LINQ syntaxe
        }

        public Task<int> SaveItemAsync(TodoItem item)
        {
            if (item.ID != 0)
            {
                return database.UpdateAsync(item);
            }
            else
            {
                return database.InsertAsync(item);
            }
        }

        public Task<int> DeleteItemAsync(TodoItem item)
        {
            return database.DeleteAsync(item);
        }
    }
    </code>

 Třída TodoItem je entita, která reprezentuje tabulku v databázi, je možné s ní pracovat přímo v kódu. 

    <code class="language-C# ">public class TodoItem
    {
        [PrimaryKey, AutoIncrement]
        public int ID { get; set; }
        public string Name { get; set; }
        public string Text { get; set; }

        public int Done { get; set; }
        public TodoItem()
        {
        }

        public override string ToString()
        {
            return "ID" + ID + " Name " + Name + " Text " + Text;
        }
    }
    </code>

[ Seznam SQL atributů ](https://github.com/oysteinkrog/SQLite.Net-PCL/tree/master/src/SQLite.Net/Attributes)

#### Zápis struktury databáze do souboru a udržení spojení

 Před započetím práce s databází musí být její struktura zapsána do souboru, kam se ukládají data a vrátit aktuální instanci připojené databáze. 

 Způsob vytvoření databáze a vrácení aktuání instance popsaný níže, připojí databázi ve chvíli, kdy to aplikace potřebuje a drží otevřené připojení až do ukončení aplikace. 

    <code class="language-C# ">private static TodoItemDatabase _database;

    public static TodoItemDatabase Database
    {
        get
        {
            if (_database == null)
            {
                 var fileHelper = new FileHelper();
                _database = new TodoItemDatabase(fileHelper.GetLocalFilePath("TodoSQLite.db3"));
            }
            return _database;
        }
    }
    </code>

 Třída FileHelper pouze vrací cestu k databázovém souboru. V tomto případě se databázový soubor vytvoří na stejném místě jako je spouštěcí .exe soubor aplikace. 

    <code class="language-C# ">class FileHelper
    {
        public string GetLocalFilePath(string filename)
        {
            return Path.Combine("", filename);
        }
    }
    </code>

#### Práce s databází

 Přidání položky to databáze využívající připojení k databázi viz. příklad výše. 

    <code class="language-C# ">TodoItem item = new TodoItem();
    item.Name = "item";
    item.Text = "item text";
    item.Done = 0;
    Database.SaveItemAsync(item);
    </code>

 Získání všech položek třídy TodoItem z databáze. 

    <code class="language-C# ">var itemsFromDb = Database.GetItemsNotDoneAsync().Result;
    </code>

 Výpis všech položek a jejich celkového počtu. 

    <code class="language-C# ">var itemsFromDb = Database.GetItemsNotDoneAsync().Result;

    Debug.WriteLine(itemsFromDb.Count);
    foreach (TodoItem todoItem in itemsFromDb)
    {
        Debug.WriteLine(todoItem);
    }</code>

[Zdrojový projekt pro WPF aplikaci](https://github.com/malyda/WPF-SQLite.git)

[Xamarin Tutorial - official](https://developer.xamarin.com/guides/xamarin-forms/working-with/databases/)

[Xamarin Tutoriál](https://developer.xamarin.com/guides/xamarin-forms/working-with/databases/)