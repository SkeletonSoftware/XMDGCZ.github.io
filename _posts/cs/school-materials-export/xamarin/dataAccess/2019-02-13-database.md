---
layout: post
title: "database.php "
categories:
    -"xamarin"
    -"xamarin"
author: "David Malý"
--- 


## Databáze


<br>    Všechny mobilní platformy mají přístup k nativní SQLite databázi, Xamarin umožňuje tuto databázi bez problémů používat.<br>


### Vytvoření a použití databáze


<br>    Následující ukázka je vytvořená pro potřeby Xamarin se sdíleným kódem v PCL. Ukazuje práci s tabulkou TodoItem.<br>


#### Nuget balíček


[SQLite-net PCL](https://github.com/praeclarum/sqlite-net) je doporučený balíček pro práci s SQLite databází v Xamarin PCL. Je aktivně vyvíjený a podporuje veškerou potřebnou funkčnost pro práci s SQLite databází.<br>



<br>    Balíček se skládá z částí pro využití v PCL a nativního kódu pro každou platformu.<br>


#### SQLite connection a seznam základních Query


<br>    Před samotnou prací s databází vytvoříme třídu, která zahrnuje všechny metody pro obsluhu databáze.<br>


```

public  class TodoItemDatabase
{
    private SQLiteAsyncConnection database;

    public TodoItemDatabase(string dbPath)
    {
        database = new SQLiteAsyncConnection(dbPath);
        database.CreateTableAsync<TodoItem>().Wait();
    }


    public Task<List<TodoItem>> GetItemsAsync()
    {
        return database.Table<TodoItem>().ToListAsync();
    }

    public Task<List<TodoItem>> GetItemsNotDoneAsync()
    {
        return database.QueryAsync<TodoItem>("SELECT * FROM [TodoItem] WHERE [Done] = 0");
    }

    public Task<TodoItem> GetItemAsync(int id)
    {
        return database.Table<TodoItem>().Where(i => i.ID == id).FirstOrDefaultAsync();
    }

    public Task<int> SaveItemAsync(TodoItem item)
    {
        if (item.ID != 0)
        {
            return database.UpdateAsync(item);
        }
        else
        {
            return database.InsertAsync(item);
        }
    }

    public Task<int> DeleteItemAsync(TodoItem item)
    {
        return database.DeleteAsync(item);
    }
}

```


<br>    Část pro SQLite connection a vytvoření tabulky TodoItem (zápis do databázového souboru).<br>


```

private SQLiteAsyncConnection database;

public TodoItemDatabase(string dbPath)
{
    database = new SQLiteAsyncConnection(dbPath);
    database.CreateTableAsync<TodoItem>().Wait();
}

```

#### Tabulka TodoItem


<br>    Na základě třídy TodoItem se vytvoří tabulka TodoItem v databázi, která je stejná. Pro potřeby indexace se do třídy přidají tagy pro SQLite databázi - PrimaryKey a AutoIncrement pro primární klíč.<br>


```

public  class TodoItem
{
    [PrimaryKey, AutoIncrement]
    public int ID { get; set; }
    public string Name { get; set; }
    public string Text { get; set; }

    public TodoItem()
    {
    }

    public override string ToString()
    {
        return "ID" + ID + " Name " + Name + " Text " + Text;
    }
}

```
[Seznam SQL atributů](https://github.com/oysteinkrog/SQLite.Net-PCL/tree/master/src/SQLite.Net/Attributes)
#### Databázový soubor v nativním uložišti


<br>    Celá aplikace využívá SQLite connection ze třidy TodoItemDatabase, ta ale zatím nezná cestu k databázovému souboru. Lokace tohoto souboru je na každé platformě jiná, proto je potřeba zavolat nativní kód, který tuto lokaci zjistí.<br>



<br>    Nejprve si připravíme atribut, který bude udržovat spojení s databází a poté pomocí Dependency service zjistíme cestu k databázovému souboru.<br>


```

private static TodoItemDatabase _database;

public static TodoItemDatabase Database
{
    get
    {
        if (_database == null)
        {
            _database = new TodoItemDatabase(DependencyService.Get<IFileHelper>().GetLocalFilePath("TodoSQLite.db3"));
        }
        return _database;
    }
}

```


<br>    Pro Dependency service je potřeba Interface a třídy, které ho implementují. Implementační třídy se nalézají v podprojektech daných platforem.<br>


##### <br>    Interface<br>

```

public interface IFileHelper
{
    string GetLocalFilePath(string filename);
}

```

##### Android

```

[assembly: Dependency(typeof(FileHelper))]
namespace SQLiteExample.Droid
{
    public class FileHelper : IFileHelper
    {
        public string GetLocalFilePath(string filename)
        {
            string path = System.Environment.GetFolderPath(System.Environment.SpecialFolder.Personal);
            return Path.Combine(path, filename);
        }
    }
}

```

##### iOS

```

[assembly: Dependency(typeof(FileHelper))]
namespace SQLiteExample.iOS
{
    public class FileHelper : IFileHelper
    {
        public string GetLocalFilePath(string filename)
        {
            string docFolder = Environment.GetFolderPath(Environment.SpecialFolder.Personal);
            string libFolder = Path.Combine(docFolder, "..", "Library", "Databases");

            if (!Directory.Exists(libFolder))
            {
                Directory.CreateDirectory(libFolder);
            }

            return Path.Combine(libFolder, filename);
        }
    }
}

```

##### UWP

```

[assembly: Dependency(typeof(FileHelper))]
namespace SQLiteExample.UWP
{
    public class FileHelper : IFileHelper
    {
        public string GetLocalFilePath(string filename)
        {
            return Path.Combine(ApplicationData.Current.LocalFolder.Path, filename);
        }
    }
}

```
[Práce s databází - tutoriál](https://developer.xamarin.com/guides/xamarin-forms/working-with/databases/)



[Ukázkový projekt](https://github.com/malyda/Xamarin-SQLite)