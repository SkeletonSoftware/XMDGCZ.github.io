## Databáze

 Všechny mobilní platformy mají přístup k nativní SQLite databázi, Xamarin umožňuje tuto databázi bez problémů používat. 

### Vytvoření a použití databáze

 Následující ukázka je vytvořená pro potřeby Xamarin se sdíleným kódem v PCL. Ukazuje práci s tabulkou TodoItem. 

#### Nuget balíček

 [SQLite-net PCL](https://github.com/praeclarum/sqlite-net) je doporučený balíček pro práci s SQLite databází v Xamarin PCL. Je aktivně vyvíjený a podporuje veškerou potřebnou funkčnost pro práci s SQLite databází. 

 Balíček se skládá z částí pro využití v PCL a nativního kódu pro každou platformu. 

#### SQLite connection a seznam základních Query

 Před samotnou prací s databází vytvoříme třídu, která zahrnuje všechny metody pro obsluhu databáze. 

    <code class="language-C# ">public  class TodoItemDatabase
    {
        private SQLiteAsyncConnection database;

        public TodoItemDatabase(string dbPath)
        {
            database = new SQLiteAsyncConnection(dbPath);
            database.CreateTableAsync<TodoItem>().Wait();
        }

        public Task<List<TodoItem>> GetItemsAsync()
        {
            return database.Table<TodoItem>().ToListAsync();
        }

        public Task<List<TodoItem>> GetItemsNotDoneAsync()
        {
            return database.QueryAsync<TodoItem>("SELECT * FROM [TodoItem] WHERE [Done] = 0");
        }

        public Task<TodoItem> GetItemAsync(int id)
        {
            return database.Table<TodoItem>().Where(i => i.ID == id).FirstOrDefaultAsync();
        }

        public Task<int> SaveItemAsync(TodoItem item)
        {
            if (item.ID != 0)
            {
                return database.UpdateAsync(item);
            }
            else
            {
                return database.InsertAsync(item);
            }
        }

        public Task<int> DeleteItemAsync(TodoItem item)
        {
            return database.DeleteAsync(item);
        }
    }
    </code>

 Část pro SQLite connection a vytvoření tabulky TodoItem (zápis do databázového souboru). 

    <code class="language-C# ">private SQLiteAsyncConnection database;

    public TodoItemDatabase(string dbPath)
    {
        database = new SQLiteAsyncConnection(dbPath);
        database.CreateTableAsync<TodoItem>().Wait();
    }
    </code>

#### Tabulka TodoItem

 Na základě třídy TodoItem se vytvoří tabulka TodoItem v databázi, která je stejná. Pro potřeby indexace se do třídy přidají tagy pro SQLite databázi - PrimaryKey a AutoIncrement pro primární klíč. 

    <code class="language-C# ">public  class TodoItem
    {
        [PrimaryKey, AutoIncrement]
        public int ID { get; set; }
        public string Name { get; set; }
        public string Text { get; set; }

        public TodoItem()
        {
        }

        public override string ToString()
        {
            return "ID" + ID + " Name " + Name + " Text " + Text;
        }
    }
    </code>

[ Seznam SQL atributů ](https://github.com/oysteinkrog/SQLite.Net-PCL/tree/master/src/SQLite.Net/Attributes)

#### Databázový soubor v nativním uložišti

 Celá aplikace využívá SQLite connection ze třidy TodoItemDatabase, ta ale zatím nezná cestu k databázovému souboru. Lokace tohoto souboru je na každé platformě jiná, proto je potřeba zavolat nativní kód, který tuto lokaci zjistí. 

 Nejprve si připravíme atribut, který bude udržovat spojení s databází a poté pomocí Dependency service zjistíme cestu k databázovému souboru. 

    <code class="language-C# ">private static TodoItemDatabase _database;

    public static TodoItemDatabase Database
    {
        get
        {
            if (_database == null)
            {
                _database = new TodoItemDatabase(DependencyService.Get<IFileHelper>().GetLocalFilePath("TodoSQLite.db3"));
            }
            return _database;
        }
    }
    </code>

 Pro Dependency service je potřeba Interface a třídy, které ho implementují. Implementační třídy se nalézají v podprojektech daných platforem. 

##### 
    Interface

    <code class="language-C# ">public interface IFileHelper
    {
        string GetLocalFilePath(string filename);
    }
    </code>

##### Android

    <code class="language-C# ">[assembly: Dependency(typeof(FileHelper))]
    namespace SQLiteExample.Droid
    {
        public class FileHelper : IFileHelper
        {
            public string GetLocalFilePath(string filename)
            {
                string path = System.Environment.GetFolderPath(System.Environment.SpecialFolder.Personal);
                return Path.Combine(path, filename);
            }
        }
    }
    </code>

##### iOS

    <code class="language-C# ">[assembly: Dependency(typeof(FileHelper))]
    namespace SQLiteExample.iOS
    {
        public class FileHelper : IFileHelper
        {
            public string GetLocalFilePath(string filename)
            {
                string docFolder = Environment.GetFolderPath(Environment.SpecialFolder.Personal);
                string libFolder = Path.Combine(docFolder, "..", "Library", "Databases");

                if (!Directory.Exists(libFolder))
                {
                    Directory.CreateDirectory(libFolder);
                }

                return Path.Combine(libFolder, filename);
            }
        }
    }
    </code>

##### UWP

    <code class="language-C# ">[assembly: Dependency(typeof(FileHelper))]
    namespace SQLiteExample.UWP
    {
        public class FileHelper : IFileHelper
        {
            public string GetLocalFilePath(string filename)
            {
                return Path.Combine(ApplicationData.Current.LocalFolder.Path, filename);
            }
        }
    }
    </code>

[Práce s databází - tutoriál](https://developer.xamarin.com/guides/xamarin-forms/working-with/databases/)

[Ukázkový projekt](https://github.com/malyda/Xamarin-SQLite)